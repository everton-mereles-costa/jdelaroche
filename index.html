<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ateliê de la Roche - Galeria & Curadoria</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Estilos Gerais --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #2c2c2c; color: #f0f0f0; margin: 0; padding: 2rem; }
        
        /* --- Cabeçalho e Navegação --- */
        .header { text-align: center; border-bottom: 1px solid #555; padding-bottom: 1.5rem; margin-bottom: 2rem; }
        .header h1 { margin: 0 0 0.5rem; }
        .header p { margin: 0; color: #ccc; max-width: 800px; margin-left: auto; margin-right: auto; line-height: 1.5; }
        .nav-tabs { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; }
        .nav-tab { background-color: #3a3a3a; color: #f0f0f0; padding: 0.8rem 1.5rem; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.2s; }
        .nav-tab:hover { background-color: #4a4a4a; }
        .nav-tab.active { background-color: #007bff; color: white; }

        /* --- Seções da Galeria --- */
        .gallery-section { display: none; }
        .gallery-section.active { display: block; }
        .gallery-grid { display: flex; flex-wrap: wrap; gap: 2rem; justify-content: center; }
        .empty-state { text-align: center; font-size: 1.2rem; padding: 4rem; color: #888; }
        
        /* --- Estilos dos Cards Refinados --- */
        .card { background-color: #3a3a3a; border-radius: 8px; overflow: hidden; width: 350px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .card img { width: 100%; height: 350px; object-fit: cover; background-color: #222; cursor: pointer; transition: transform 0.2s; }
        .card img:hover { transform: scale(1.03); }
        .card-content { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        .card-title { font-size: 1.2rem; font-weight: bold; margin: 0; }
        .execution-year { font-style: italic; font-weight: normal; color: #ccc; margin: 0.1rem 0 0.8rem 0; font-size: 1rem; }
        .scene-era { font-weight: bold; color: #bbb; margin-bottom: 1rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .text-summary { 
            position: relative; 
            max-height: 3.6em; /* Limita a altura para aproximadamente 2 linhas de texto */
            overflow: hidden; 
            font-size: 0.9rem;
            color: #ccc;
            line-height: 1.8em;
        }
        .text-summary::after {
            content: '...';
            position: absolute;
            bottom: 0;
            right: 0;
            background: linear-gradient(to right, rgba(58, 58, 58, 0), #3a3a3a 50%);
            padding-left: 1rem;
        }
        
        .card-actions { display: flex; gap: 1rem; padding: 1rem 0 0 0; border-top: 1px solid #555; margin-top: auto; }
        .approve-btn { background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: all 0.2s; padding: 0.8rem; flex-grow: 1;}
        .reject-btn { background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: all 0.2s; padding: 0.8rem; flex-grow: 1;}
        .approve-btn:hover { background-color: #218838; }
        .reject-btn:hover { background-color: #c82333; }
        .card.processing { opacity: 0.5; pointer-events: none; }
        
        /* --- Estilos do Lightbox --- */
        #lightbox { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); cursor: pointer; }
        #lightbox .content { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; padding: 2rem; box-sizing: border-box; gap: 2rem; }
        #lightbox img { max-width: 65%; max-height: 90%; box-shadow: 0 0 25px rgba(0,0,0,0.8); object-fit: contain; cursor: default; }
        #lightbox-info { width: 30%; max-height: 90%; overflow-y: auto; color: #fff; cursor: default; }
        #lightbox-info h2 { font-size: 1.8rem; margin-bottom: 0.2rem; }
        #lightbox-info h3 { font-style: italic; font-weight: normal; color: #ddd; margin-top: 0; margin-bottom: 1.5rem; }
        #lightbox-info h4 { font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #ccc; margin-bottom: 0.5rem; }
        #lightbox-motivation { font-style: italic; font-size: 1.1rem; color: #ddd; border-left: 3px solid #777; padding-left: 1.5rem; margin: 1.5rem 0; }
        #lightbox-info p { line-height: 1.6; font-size: 1.1rem; }
        #lightbox.active { display: flex; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Ateliê de Jérôme de la Roche</h1>
        <p>Mestre do Crono-Realismo (1798-1874), Jérôme de la Roche dedicou sua vida a rejeitar o romantismo e a pintar a história como ela "realmente foi". Seu foco eram os momentos não vistos: a logística, a exaustão e a humanidade crua por trás dos grandes eventos. Esta galeria apresenta as suas obras redescobertas para curadoria.</p>
    </div>

    <nav class="nav-tabs">
        <button class="nav-tab active" data-tab="pending">Para Revisar</button>
        <button class="nav-tab" data-tab="approved">Galeria Aprovada</button>
    </nav>
    
    <section id="pending" class="gallery-section active">
        <div id="gallery-pending" class="gallery-grid">
            <p id="loading-pending">Carregando obras para revisar...</p>
        </div>
    </section>
    
    <section id="approved" class="gallery-section">
        <div id="gallery-approved" class="gallery-grid">
            <p id="loading-approved">Carregando galeria aprovada...</p>
        </div>
    </section>

    <div id="lightbox">
        <div class="content">
            <img src="" alt="Visão ampliada">
            <div id="lightbox-info">
                <h2 id="lightbox-title"></h2>
                <h3 id="lightbox-execution-year"></h3>
                <h4 id="lightbox-scene-era"></h4>
                <p id="lightbox-motivation"></p>
                <p id="lightbox-description"></p>
            </div>
        </div>
    </div>

    <template id="card-template">
        <div class="card">
            <img src="" alt="Artwork">
            <div class="card-content">
                <h3 class="card-title"></h3>
                <h4 class="execution-year"></h4>
                <p class="scene-era"></p>
                <div class="text-summary"></div>
            </div>
            <div class="card-actions">
                <button class="approve-btn">Aprovar</button>
                <button class="reject-btn">Rejeitar</button>
            </div>
        </div>
    </template>

    <script>
        const SUPABASE_URL = 'https://vzmhnponxmrvoqctmpty.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6bWhucG9ueG1ydm9xY3RtcHR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3Mzg5MjYsImV4cCI6MjA3MDMxNDkyNn0.sSfMCpPKwFp2lVLuWnFN066OT0lluMb-sd-kWb1PePg';
        const N8N_APPROVE_WEBHOOK = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/N8N_APPROVE_WEBHOOK';
        const N8N_REJECT_WEBHOOK = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/N8N_REJECT_WEBHOOK';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const tabs = document.querySelectorAll('.nav-tab');
        const sections = document.querySelectorAll('.gallery-section');
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = lightbox.querySelector('img');
        const lightboxTitle = document.getElementById('lightbox-title');
        const lightboxExecutionYear = document.getElementById('lightbox-execution-year');
        const lightboxSceneEra = document.getElementById('lightbox-scene-era');
        const lightboxMotivation = document.getElementById('lightbox-motivation');
        const lightboxDescription = document.getElementById('lightbox-description');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                sections.forEach(s => s.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        lightbox.addEventListener('click', (e) => {
            if (e.target.id === 'lightbox' || e.target.classList.contains('content')) {
                lightbox.classList.remove('active');
            }
        });

        function getGoogleDriveFileId(url) {
            if (!url) return null;
            let fileId = null;
            let match = url.match(/file\/d\/([a-zA-Z0-9_-]+)/);
            if (match) {
                fileId = match[1];
            } else {
                match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (match) fileId = match[1];
            }
            return fileId;
        }

        function createCard(idea, targetGallery) {
            const cardTemplate = document.getElementById('card-template');
            const card = cardTemplate.content.cloneNode(true).firstElementChild;
            
            const img = card.querySelector('img');
            const title = card.querySelector('.card-title');
            const executionYear = card.querySelector('.execution-year');
            const sceneEra = card.querySelector('.scene-era');
            const summaryContainer = card.querySelector('.text-summary');
            const actions = card.querySelector('.card-actions');
            
            const fileId = getGoogleDriveFileId(idea.image_url);
            if (fileId) {
                const imageUrl = `https://lh3.googleusercontent.com/d/${fileId}`;
                img.src = imageUrl;
                img.alt = idea.painting_title;

                img.addEventListener('click', () => {
                    lightboxImage.src = imageUrl;
                    lightboxTitle.textContent = idea.painting_title;
                    lightboxExecutionYear.textContent = idea.execution_year || '';
                    lightboxSceneEra.textContent = idea.era || '';
                    lightboxMotivation.textContent = `"${idea.artist_motivation || ''}"`;
                    lightboxDescription.textContent = idea.description;
                    lightbox.classList.add('active');
                });
            } else {
                img.alt = "Imagem não disponível";
                img.src = "";
            }

            title.textContent = idea.painting_title || 'Título não encontrado';
            executionYear.textContent = idea.execution_year || '';
            sceneEra.textContent = idea.era || '';
            summaryContainer.textContent = `"${idea.artist_motivation || idea.description || ''}"`;
            
            if (idea.status === 'pending_review') {
                const approveBtn = card.querySelector('.approve-btn');
                const rejectBtn = card.querySelector('.reject-btn');
                approveBtn.dataset.id = idea.id;
                rejectBtn.dataset.id = idea.id;
                rejectBtn.dataset.fileId = fileId;
                approveBtn.addEventListener('click', handleApprove);
                rejectBtn.addEventListener('click', handleReject);
            } else {
                actions.style.display = 'none';
            }
            
            targetGallery.appendChild(card);
        }

        async function fetchAndRenderAll() {
            const galleryPending = document.getElementById('gallery-pending');
            const galleryApproved = document.getElementById('gallery-approved');
            
            galleryPending.innerHTML = '<p id="loading-pending">Carregando obras para revisar...</p>';
            galleryApproved.innerHTML = '<p id="loading-approved">Carregando galeria aprovada...</p>';
            
            try {
                const { data, error } = await supabaseClient.from('scene_ideas').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                
                galleryPending.innerHTML = '';
                galleryApproved.innerHTML = '';

                const pendingItems = data.filter(item => item.status === 'pending_review');
                const approvedItems = data.filter(item => item.status === 'approved');

                if (pendingItems.length === 0) {
                    galleryPending.innerHTML = '<p class="empty-state">Nenhuma obra para revisar. O ateliê está em dia!</p>';
                } else {
                    pendingItems.forEach(idea => createCard(idea, galleryPending));
                }

                if (approvedItems.length === 0) {
                    galleryApproved.innerHTML = '<p class="empty-state">Nenhuma obra foi aprovada ainda.</p>';
                } else {
                    approvedItems.forEach(idea => createCard(idea, galleryApproved));
                }
                
            } catch (error) {
                const errorMessage = `<p class="empty-state">Erro ao buscar dados: ${error.message}</p>`;
                galleryPending.innerHTML = errorMessage;
                galleryApproved.innerHTML = errorMessage;
                 console.error('Supabase Error:', error);
            }
        }
        
        async function handleApprove(event) {
            event.stopPropagation();
            const button = event.target;
            const card = button.closest('.card');
            const ideaId = button.dataset.id;
            
            card.classList.add('processing');
            try {
                const response = await fetch(N8N_APPROVE_WEBHOOK, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: ideaId }) });
                if (!response.ok) throw new Error('Falha na rede ao aprovar.');
                
                card.querySelector('.card-actions').style.display = 'none';
                document.getElementById('gallery-approved').prepend(card);
                card.classList.remove('processing');

                if(document.getElementById('gallery-pending').children.length === 0){
                   document.getElementById('gallery-pending').innerHTML = '<p class="empty-state">Nenhuma obra para revisar. O ateliê está em dia!</p>';
                }

            } catch (error) {
                alert('Erro ao aprovar. Verifique o console.');
                console.error('Approve Error:', error);
                card.classList.remove('processing');
            }
        }

        async function handleReject(event) {
            event.stopPropagation();
            const button = event.target;
            const card = button.closest('.card');
            const ideaId = button.dataset.id;
            const fileId = button.dataset.fileId;
            
            card.classList.add('processing');
            try {
                const response = await fetch(N8N_REJECT_WEBHOOK, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: ideaId, fileId: fileId }) });
                if (!response.ok) throw new Error('Falha na rede ao rejeitar.');
                card.remove();

                if(document.getElementById('gallery-pending').children.length === 0){
                   document.getElementById('gallery-pending').innerHTML = '<p class="empty-state">Nenhuma obra para revisar. O ateliê está em dia!</p>';
                }
            } catch (error) {
                alert('Erro ao rejeitar. Verifique o console.');
                console.error('Reject Error:', error);
                card.classList.remove('processing');
            }
        }

        fetchAndRenderAll();
    </script>
</body>
</html>
